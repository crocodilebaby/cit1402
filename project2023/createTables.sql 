CREATE TABLE PhoneModel (
    modelNumber TEXT PRIMARY KEY,
    modelName TEXT,
    storage INTEGER,
    colour TEXT,
    baseCost REAL,
    dailyCost REAL
);

CREATE TABLE Customer (
    customerId INTEGER PRIMARY KEY,
    customerName TEXT,
    customerEmail TEXT
);

CREATE TABLE Phone (
    IMEI        TEXT PRIMARY KEY,
    modelNumber TEXT,
    modelName   TEXT,
    FOREIGN KEY (
        modelNumber
    )
    REFERENCES PhoneModel (modelNumber),
    CHECK (length(IMEI) == 15),
    CHECK ( (CAST (SUBSTR(IMEI, 1, 1) AS INTEGER) + CAST (SUBSTR(IMEI, 3, 1) AS INTEGER) + CAST (SUBSTR(IMEI, 5, 1) AS INTEGER) + CAST (SUBSTR(IMEI, 7, 1) AS INTEGER) + CAST (SUBSTR(IMEI, 9, 1) AS INTEGER) + CAST (SUBSTR(IMEI, 11, 1) AS INTEGER) + CAST (SUBSTR(IMEI, 13, 1) AS INTEGER) + CAST (SUBSTR(IMEI, 15, 1) AS INTEGER) + CASE CAST (SUBSTR(IMEI, 2, 1) AS INTEGER) WHEN 0 THEN 0 WHEN 1 THEN 2 WHEN 2 THEN 4 WHEN 3 THEN 6 WHEN 4 THEN 8 WHEN 5 THEN 1 WHEN 6 THEN 3 WHEN 7 THEN 5 WHEN 8 THEN 7 WHEN 9 THEN 9 END + CASE CAST (SUBSTR(IMEI, 4, 1) AS INTEGER) WHEN 0 THEN 0 WHEN 1 THEN 2 WHEN 2 THEN 4 WHEN 3 THEN 6 WHEN 4 THEN 8 WHEN 5 THEN 1 WHEN 6 THEN 3 WHEN 7 THEN 5 WHEN 8 THEN 7 WHEN 9 THEN 9 END + CASE CAST (SUBSTR(IMEI, 6, 1) AS INTEGER) WHEN 0 THEN 0 WHEN 1 THEN 2 WHEN 2 THEN 4 WHEN 3 THEN 6 WHEN 4 THEN 8 WHEN 5 THEN 1 WHEN 6 THEN 3 WHEN 7 THEN 5 WHEN 8 THEN 7 WHEN 9 THEN 9 END + CASE CAST (SUBSTR(IMEI, 8, 1) AS INTEGER) WHEN 0 THEN 0 WHEN 1 THEN 2 WHEN 2 THEN 4 WHEN 3 THEN 6 WHEN 4 THEN 8 WHEN 5 THEN 1 WHEN 6 THEN 3 WHEN 7 THEN 5 WHEN 8 THEN 7 WHEN 9 THEN 9 END + CASE CAST (SUBSTR(IMEI, 10, 1) AS INTEGER) WHEN 0 THEN 0 WHEN 1 THEN 2 WHEN 2 THEN 4 WHEN 3 THEN 6 WHEN 4 THEN 8 WHEN 5 THEN 1 WHEN 6 THEN 3 WHEN 7 THEN 5 WHEN 8 THEN 7 WHEN 9 THEN 9 END + CASE CAST (SUBSTR(IMEI, 12, 1) AS INTEGER) WHEN 0 THEN 0 WHEN 1 THEN 2 WHEN 2 THEN 4 WHEN 3 THEN 6 WHEN 4 THEN 8 WHEN 5 THEN 1 WHEN 6 THEN 3 WHEN 7 THEN 5 WHEN 8 THEN 7 WHEN 9 THEN 9 END + CASE CAST (SUBSTR(IMEI, 14, 1) AS INTEGER) WHEN 0 THEN 0 WHEN 1 THEN 2 WHEN 2 THEN 4 WHEN 3 THEN 6 WHEN 4 THEN 8 WHEN 5 THEN 1 WHEN 6 THEN 3 WHEN 7 THEN 5 WHEN 8 THEN 7 WHEN 9 THEN 9 END) % 10 == 0),
    CHECK (IMEI GLOB '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]') 
);

CREATE TABLE rentalContract (
    customerId INTEGER,
    IMEI TEXT,
    dateOut TEXT,
    dateBack TEXT,
    rentalCost REAL,
    PRIMARY KEY (customerId, IMEI, dateOut),
    FOREIGN KEY (customerId) REFERENCES Customer(customerId),
    FOREIGN KEY (IMEI) REFERENCES Phone(IMEI) ON DELETE SET NULL
);

